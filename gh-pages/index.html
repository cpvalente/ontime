<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ontime Google Sheets Login</title>

    <style>
        html,
        body {
            font-family: Arial, Helvetica, sans-serif;
            background-color: #f1f1f1;
        }

        main {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
        }
    </style>

</head>

<body>
    <main>
        <h1>Ontime Google Sheets Login</h1>

        <span>Loading...</span>
    </main>

    <script>
        if (location.hash) {
            const hash = location.hash.substring(1).split("&").reduce((result, item) => {
                const parts = item.split("=");
                result[parts[0]] = parts[1];
                return result;
            }, {});

            const ontimeUrl = hash.state;
            const accessToken = hash.access_token;

            const returnUrl = `${ontimeUrl}?accessToken=${accessToken}`;
            location.href = returnUrl;
        } else {
            const clientId = "428790026655-lb7t3jpqol568748ba8psj7d5r831333.apps.googleusercontent.com";
            const redirectUri = location.protocol + '//' + location.host + location.pathname;
            const scopes = [
                "https://www.googleapis.com/auth/spreadsheets",
            ];
            
            const loginButton = document.getElementById("login-button");
            const url = new URL("https://accounts.google.com/o/oauth2/v2/auth");
            url.searchParams.append("client_id", clientId);
            url.searchParams.append("redirect_uri", redirectUri);
            url.searchParams.append("response_type", "token");
            url.searchParams.append("scope", scopes.join(" "));
            const ontimeUrl = new URL(location).searchParams.get("ontimeUrl");
            if (!ontimeUrl) {
                alert("ontimeUrl is required");
            }
            url.searchParams.append("state", ontimeUrl);
            
            location.href = url;
        }
    </script>
</body>

</html>